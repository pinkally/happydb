<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ì•¨ë¦¬ì˜ í•´í”¼íˆ¬ë‚˜ì‡ : ë¼ì´ë¸Œì €ì¥ì†Œ</title>
    <link
      href="https://cdn.jsdelivr.net/gh/webfontworld/sCoreDream/sCoreDream.css"
      rel="stylesheet"
    />
<style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Arial', sans-serif;
      padding: 20px;
    }
    .main-title {
      font-family: 'SCoreDream', sans-serif;
      font-weight: 900;
      font-size: 1.5em;
      margin-bottom: 15px;
      text-align: left;
      color: #ffffff;
    }
    .ep-info {
      font-size: 0.55em;
      color: #ff8a80;
      margin-left: 8px;
      font-weight: 400;
      vertical-align: middle;
    }
    .section-title {
      font-family: 'SCoreDream', sans-serif;
      font-weight: 900;
      font-size: 1.2em;
      cursor: pointer;
      margin: 15px 0 5px;
      padding: 8px 12px;
      background-color: #1f1f1f;
      border-left: 5px solid #ff8a80;
      border-radius: 5px;
      transition: background-color 0.3s;
    }
    .section-title:hover {
      background-color: #2c2c2c;
    }
    .section-content {
      max-height: 0;
      overflow: hidden;
      margin: 0 0 20px;
      padding: 0 12px;
      background-color: #1e1e1e;
      border: 1px dashed #444;
      border-radius: 5px;
      transition: max-height 0.5s ease, padding 0.3s;
    }
    .section-content.open {
      padding: 12px;
      max-height: 1000px;
    }
    textarea {
      width: 100%;
      font-family: 'SCoreDream', sans-serif;
      font-size: 1em;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #444;
      background-color: #2a2a2a;
      color: #fff;
      resize: none;
      overflow-y: auto;
      box-shadow: 0 0 5px rgba(255, 138, 128, 0.3);
      line-height: 24px;
      max-height: 792px; /* 33 lines * 24px + 12px padding */
    }
    #toggle-all {
      background: #444;
      color: #eee;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      margin-bottom: 20px;
    }


    #playlistResult {
      max-height: none;
      overflow-y: visible;
      margin-top: 10px;
    }
    .hidden {
      display: none;
    }
  </style>

  </head>
  <body>
    <div class="main-title">
      ğŸ™ï¸Happy Tonight<span class="ep-info" id="epDisplay"></span>
    </div>

    <div style="margin-bottom: 10px">
      <label for="broadcastDate" style="font-weight: bold">ğŸ“… </label>
      <input
        type="text"
        id="broadcastDate"
        placeholder="ì˜ˆ: 20250423"
        style="
          margin-left: 10px;
          padding: 4px 8px;
          border-radius: 5px;
          border: 1px solid #888;
          background-color: #1e1e1e;
          color: #fff;
        "
      />
      <button
        onclick="handleDateChange()"
        style="
          margin-left: 10px;
          padding: 4px 10px;
          border-radius: 5px;
          border: none;
          background: #ff8a80;
          color: #fff;
          font-weight: bold;
          cursor: pointer;
        "
      >ë¶ˆëŸ¬ì˜¤ê¸°</button
      > <button id="toggle-all" onclick="toggleAll()">Open</button>
    </div>



    <div id="contentSections" class="hidden">
      <!-- ë°©ì†¡ì œëª© ~ í´ë¡œì§•ê¹Œì§€ì˜ textarea ì˜ì—­ë“¤ -->
    <div class="section-title" onclick="toggleSection('title')">ğŸ™ ë°©ì†¡ì œëª©</div>
    <div id="title" class="section-content">
      <textarea id="titleInput" oninput="saveTitleText()">ğŸ§ ê°ì„± ë¼ë””ì˜¤ï½œ[ë°©ì†¡ì£¼ì œ ì…ë ¥] ì‚¬ì—°+ì‹ ì²­ê³¡ï½œí•´í”¼íˆ¬ë‚˜ì‡ EP.[íšŒì°¨] â™¬â™ª [ë°©ì†¡ë‚ ì§œ]</textarea>
    </div>

    <div class="section-title" onclick="toggleSection('topic')">ğŸ’¡ ë°©ì†¡ì£¼ì œ</div>
    <div id="topic" class="section-content">
      <textarea placeholder="ì˜¤ëŠ˜ ë°©ì†¡ì˜ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                oninput="autoResize(this); saveContent('topic', this.value)"></textarea>
    </div>

    <div class="section-title" onclick="toggleSection('opening')">ğŸŒ™ ì˜¤í”„ë‹</div>
    <div id="opening" class="section-content">
      <textarea placeholder="ì˜¤í”„ë‹ ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                oninput="autoResize(this); saveContent('opening', this.value)"></textarea>
    </div>

    <div class="section-title" onclick="toggleSection('main')">ğŸ§ ë©”ì¸</div>
    <div id="main" class="section-content">
      <textarea placeholder="ë©”ì¸ ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                oninput="autoResize(this); saveContent('main', this.value)"></textarea>
    </div>

    <div class="section-title" onclick="toggleSection('story')">ğŸ’Œ ì‚¬ì—°</div>
    <div id="story" class="section-content">
      <textarea placeholder="ì²­ì·¨ì ì‚¬ì—°ì„ ì…ë ¥í•˜ì„¸ìš”"
                oninput="autoResize(this); saveContent('story', this.value)"></textarea>
    </div>

    <div class="section-title" onclick="toggleSection('closing')">ğŸŒŸ í´ë¡œì§•</div>
    <div id="closing" class="section-content">
      <textarea placeholder="í´ë¡œì§• ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                oninput="autoResize(this); saveContent('closing', this.value)"></textarea>
    </div>


      <!-- ì„ ê³¡ë¦¬ìŠ¤íŠ¸ì™€ ì¶œì„ì²´í¬ ì˜ì—­ -->
   <div class="section-title" onclick="toggleSection('playlist')">
  ğŸ¶ ì„ ê³¡ë¦¬ìŠ¤íŠ¸
 <button class="refresh-button" onclick="event.stopPropagation(); fetchPlaylistAuto();" style="margin-left:10px; padding:4px 10px; border-radius:5px; border:none; background:#ff8a80; color:#fff; font-weight:bold; cursor:pointer;">NEW</button></div>
    <div id="playlist" class="section-content">
      <label style="font-weight:bold; display:block; margin-bottom:6px;">âœï¸ ì•¨ë¦¬ ì„ ê³¡</label>
      <textarea
        id="playlistMemo"
        placeholder="ì„¸ìƒì—ì„œ ê°€ì¥ í–‰ë³µí•œ ë°ì´íŠ¸ì˜ ì•„ë¦„ë‹¤ìš´ ì„ ê³¡ ğŸ¶"
        oninput="saveManualPlaylist()"
        style="width:100%; height:150px; margin-bottom:15px;"></textarea>

      <label style="font-weight:bold; display:block; margin-bottom:6px;">ğŸ“¡ ì‹ ì²­ê³¡ ë¦¬ìŠ¤íŠ¸</label>
      <ul id="playlistResult">
        <li>ì•„ì´ì¿  ì‹ ì²­ê³¡ ë¯¸ë‹¬ ì‚¬íƒœ ğŸ˜­</li>
      </ul>
    </div>

<div class="section-title" onclick="toggleSection('attendance')">
  ğŸ§ ì¶œì„ì²´í¬
    <button class="refresh-button" onclick="event.stopPropagation(); loadAttendanceList();" style="margin-left:10px; padding:4px 10px; border-radius:5px; border:none; background:#ff8a80; color:#fff; font-weight:bold; cursor:pointer;">NEW</button>
</div>
    <div id="attendance" class="section-content">
      <ul id="attendanceList">
        <li>ì•„ì§ì€ ì¶œê·¼ ì „ì´ë¼ ğŸ˜­</li>
      </ul>
    </div>
<div style="margin-top: 30px;">
  <button onclick="copyMarkdown()" style="padding: 6px 12px; background-color: #ff8a80; border: none; color: white; font-weight: bold; border-radius: 6px; cursor: pointer;">
    Copy
  </button>

<button onclick="saveToGoogleSheet()" style="padding: 6px 12px; background-color: #ff8a80; border: none; color: white; font-weight: bold; border-radius: 6px; cursor: pointer;">
    Save
  </button>

  <pre id="markdownOutput" style="white-space: pre-wrap; background-color: #1e1e1e; color: #ccc; padding: 12px; border-radius: 8px; margin-top: 12px; border: 1px solid #444;"></pre>
</div>

    </div>

    <script>
  const BASE_EP = 118;
  const BASE_DATE = new Date(2025, 4, 10); // 2025-05-10

  function handleDateChange() {
    const dateStr = document.getElementById("broadcastDate").value.trim();
    if (dateStr.length !== 8 || isNaN(Number(dateStr))) {
      alert("ë‚ ì§œëŠ” 8ìë¦¬ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš” (ì˜ˆ: 20250423)");
      return;
    }

    const epNumber = calculateEPNumber(dateStr);
    const epText = `EP.${epNumber} â™¬â™ª ${dateStr}`;
    const defaultTitle = `ğŸ§ ê°ì„± ë¼ë””ì˜¤ï½œ[ë°©ì†¡ì£¼ì œ ì…ë ¥] ì‚¬ì—°+ì‹ ì²­ê³¡ï½œí•´í”¼íˆ¬ë‚˜ì‡ ${epText}`;
    const titleInput = document.getElementById("titleInput");

    // í•­ìƒ ê¸°ë³¸ ì œëª©ìœ¼ë¡œ ì„¸íŒ… (ë®ì–´ì“°ê¸°)
    titleInput.value = defaultTitle;
    saveContent("title", defaultTitle);
    updateEPInfo(defaultTitle);

    document.getElementById("buttonRow")?.classList.remove("hidden");
    document.getElementById("contentSections")?.classList.remove("hidden");

    // âœ… ì´ˆê¸°í™”
    ['topic', 'opening', 'main', 'story', 'closing'].forEach(id => {
      const textarea = document.querySelector(`#${id} textarea`);
      if (textarea) textarea.value = "";
    });
    document.getElementById("playlistMemo").value = "";
    document.getElementById("playlistResult").innerHTML = "<li>ì•„ì´ì¿  ì‹ ì²­ê³¡ ë¯¸ë‹¬ ì‚¬íƒœ ğŸ˜­</li>";
    document.getElementById("attendanceList").innerHTML = "<li>ì•„ì§ì€ ì¶œê·¼ ì „ì´ë¼ ğŸ˜­</li>";

    loadContent();
    loadManualPlaylist();
    loadAttendanceList();
    fetchPlaylistAuto();
  }

  function calculateEPNumber(dateStr) {
    const target = new Date(
      Number(dateStr.substring(0, 4)),
      Number(dateStr.substring(4, 6)) - 1,
      Number(dateStr.substring(6, 8))
    );
    const diffDays = Math.floor((target - BASE_DATE) / (1000 * 60 * 60 * 24));
    let count = 0;
    for (let i = 0; i <= diffDays; i++) {
      const d = new Date(BASE_DATE.getTime() + i * 86400000);
      if (d.getDay() === 3 || d.getDay() === 6) count++;
    }
    return BASE_EP + count - 1;
  }

  function getDateKey(key) {
    const date = document.getElementById("broadcastDate").value.trim() || "DEFAULT";
    return `script_${key}_${date}`;
  }

  function saveContent(key, value) {
    localStorage.setItem(getDateKey(key), value);
  }

  function loadContent() {
  const fields = ['title', 'topic', 'opening', 'main', 'story', 'closing'];
  fields.forEach(id => {
    const textarea = document.querySelector(`#${id} textarea`);
    if (!textarea) return;

    const content = localStorage.getItem(getDateKey(id));
    if (content && content.trim() !== "") {
      textarea.value = content;
      autoResize(textarea);
      if (id === 'title') updateEPInfo(content);
    } else {
      textarea.value = ""; // ì´ì „ ê°’ ì§€ì›€
      autoResize(textarea); // í¬ê¸° ì´ˆê¸°í™”
    }
  });
}


  function saveManualPlaylist() {
    const val = document.getElementById("playlistMemo").value;
    localStorage.setItem(getDateKey("manualPlaylist"), val);
  }

  function loadManualPlaylist() {
    const val = localStorage.getItem(getDateKey("manualPlaylist"));
    if (val) {
      document.getElementById("playlistMemo").value = val;
    }
  }

  function toggleSection(id) {
    const section = document.getElementById(id);
    section.classList.toggle("open");
  }

  function toggleAll() {
    const sections = document.querySelectorAll(".section-content");
    const shouldOpen = ![...sections].every(sec => sec.classList.contains("open"));
    sections.forEach(sec => sec.classList.toggle("open", shouldOpen));
  }

  function autoResize(textarea) {
    textarea.style.height = 'auto';
    const lineCount = textarea.value.split('\n').length;
    if (lineCount <= 33) {
      textarea.style.overflowY = 'hidden';
      textarea.style.height = textarea.scrollHeight + 'px';
    } else {
      textarea.style.overflowY = 'auto';
      const lineHeight = 24;
      const maxHeight = lineHeight * 33 + 12;
      textarea.style.height = `${maxHeight}px`;
    }
  }

  function updateEPInfo(titleText) {
    const match = titleText.match(/EP\.\d{1,4}\s[â™¬â™ª]+\s\d{8}/);
    const display = document.getElementById("epDisplay");
    display.textContent = match ? ` - ${match[0]}` : '';
  }

 async function fetchPlaylistAuto() {
  const date = document.getElementById("broadcastDate").value.trim();
  const list = document.getElementById("playlistResult");

  // âœ… ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸êµ¬ë¥¼ ë¨¼ì € ë³´ì—¬ì¤Œ
  list.innerHTML = "<li>ì‹ ì²­ê³¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>";
    if (!date) {
      console.warn("â›” ë°©ì†¡ ë‚ ì§œê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      return;
    }

    const url = `https://script.google.com/macros/s/AKfycbzDz0Af1Kzio7X_Adqq4pkgkmlutLkCUN6Qo4tlTwGG-J3VvyxO-O0L0L_j4Oqh2gObxg/exec?type=requestlist&D=${date}`;

    try {
      const response = await fetch(url);
      const data = await response.json();
         // âœ… ë°›ì€ ë°ì´í„°ê°€ ë¹„ì—ˆì„ ê²½ìš°
    if (!data || data.length === 0) {
      list.innerHTML = "<li>ì•„ì´ì¿  ì‹ ì²­ê³¡ ë¯¸ë‹¬ ì‚¬íƒœ ğŸ˜¢</li>";
      return;
    }

    // âœ… ì •ìƒ ë°ì´í„° í‘œì‹œ
    list.innerHTML = "";
    data.forEach(song => {
      const li = document.createElement("li");
      li.textContent = song;
      list.appendChild(li);
    });

  } catch (error) {
    console.error("ğŸµ ì‹ ì²­ê³¡ ìë™ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
    list.innerHTML = "<li>ì‹ ì²­ê³¡ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ ğŸ˜¢</li>";
  }
}

  function loadAttendanceList() {
    const titleText = localStorage.getItem(getDateKey("title")) || "";
    const dateMatch = titleText.match(/\d{8}$/);
    if (!dateMatch) return;
    const date = dateMatch[0];
    const ul = document.getElementById("attendanceList");
    ul.innerHTML = '<li>ì¶œì„ì ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>';

    const url = `https://script.google.com/macros/s/AKfycbxXWYEgCyeAz1c_JFQGVbn7AASCNU3gZQ5janozphQVD31AE3Wylip2DmWP89Fny0Lxyg/exec?L=${date}&type=list`;

    fetch(url)
      .then(res => res.json())
      .then(data => {
        ul.innerHTML = '';
        if (data.length === 0) {
          ul.innerHTML = '<li>ì•„ì§ì€ ì¶œê·¼ ì „ì´ë¼ ğŸ˜­</li>';
        } else {
          data.forEach(id => {
            const li = document.createElement('li');
            li.textContent = id;
            ul.appendChild(li);
          });
        }
      })
      .catch(err => {
        console.error(err);
        ul.innerHTML = '<li>ì¶œì„ì ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ ğŸ˜¢</li>';
      });
  }

  async function saveToGoogleSheet() {
  const date = document.getElementById('broadcastDate').value.trim();
  const title = document.getElementById('titleInput').value.trim();
  const fields = ['topic', 'opening', 'main', 'story', 'closing'];
  const data = { date, title };

  fields.forEach(id => {
    const textarea = document.querySelector(`#${id} textarea`);
    data[id] = textarea ? textarea.value.trim() : '';
  });

  data.manualPlaylist = document.getElementById('playlistMemo')?.value.trim() || '';

  const autoSongs = [];
  document.querySelectorAll('#playlistResult li').forEach(li => {
    const song = li.textContent.trim();
    if (
      song &&
      song !== 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...' &&
      song !== 'ì•„ì´ì¿  ì‹ ì²­ê³¡ ë¯¸ë‹¬ ì‚¬íƒœ ğŸ˜¢' &&
      song !== 'ì‹ ì²­ê³¡ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ ğŸ˜¢'
    ) {
      autoSongs.push(song);
    }
  });
  data.autoPlaylist = autoSongs;

  const attendees = [];
  document.querySelectorAll('#attendanceList li').forEach(li => {
    const id = li.textContent.trim();
    if (
      id &&
      id !== 'ì¶œì„ì ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...' &&
      id !== 'ì•„ì§ì€ ì¶œê·¼ ì „ì´ë¼ ğŸ˜­' &&
      id !== 'ì¶œì„ìê°€ ì—†ìŠµë‹ˆë‹¤.' &&
      id !== 'ì¶œì„ì ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ ğŸ˜¢'
    ) {
      attendees.push(id);
    }
  });
  data.attendanceList = attendees;

  try {
    const response = await fetch('https://script.google.com/macros/s/AKfycbyucinTFRZ04xlVTfjeBKQ6t931j_BTFZfBQ-ehwf3NBWo3M6C4xd3-q_zt2lvFkufAlg/exec', {
      method: 'POST',
      body: JSON.stringify(data),
      headers: { 'Content-Type': 'application/json' },
    });

    const text = await response.text();
    alert(text);
  } catch (error) {
    console.error(error);
    alert('âŒ ì‹œíŠ¸ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
  }
}


  window.onload = () => {
    document.getElementById("broadcastDate").value = "20250423"; // ì˜ˆì‹œ ë‚ ì§œ
    handleDateChange();


    setInterval(fetchPlaylistAuto, 20 * 60 * 1000); // 20ë¶„ë§ˆë‹¤ ì‹ ì²­ê³¡ ê°±ì‹ 
  };

window.copyMarkdown = function () {
  const date = document.getElementById('broadcastDate').value.trim();
  const title = document.getElementById('titleInput').value.trim();
  const fields = ['topic', 'opening', 'main', 'story', 'closing'];
  const data = { date, title };

  fields.forEach(id => {
    const textarea = document.querySelector(`#${id} textarea`);
    data[id] = textarea ? textarea.value.trim() : '';
  });

  data.manualPlaylist = document.getElementById('playlistMemo')?.value.trim() || '';

  const autoSongs = [];
  document.querySelectorAll('#playlistResult li').forEach(li => {
    const song = li.textContent.trim();
    if (song && !song.includes('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘')) {
      autoSongs.push(song);
    }
  });

  const attendees = [];
  document.querySelectorAll('#attendanceList li').forEach(li => {
    const id = li.textContent.trim();
    if (id && !id.includes('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘')) {
      attendees.push(id);
    }
  });

  const markdown = `ğŸ™í•´í”¼íˆ¬ë‚˜ì‡ ë°©ì†¡ ê¸°ë¡ - ${formatDate(date)}

ğŸ“Œ ë°©ì†¡ ì œëª©  
${title}

ğŸ’¡ ë°©ì†¡ ì£¼ì œ 
${data.topic || '-'}

ğŸŒ™ ì˜¤í”„ë‹ ë©˜íŠ¸ 
${data.opening || '-'}


ğŸ§ ë©”ì¸ ë©˜íŠ¸ 
${data.main || '-'}


ğŸ’Œ ì‚¬ì—° ì†Œê°œ 
${data.story || '-'}


ğŸŒŸ í´ë¡œì§• ë©˜íŠ¸  
${data.closing || '-'}


ğŸ¶ ì•¨ë¦¬ ì„ ê³¡  
${data.manualPlaylist ? '- ' + data.manualPlaylist.split('\n').join('\n- ') : '-'}

ğŸ“¡ ì‹ ì²­ê³¡ ë¦¬ìŠ¤íŠ¸ 
${autoSongs.length ? autoSongs.map(s => '- ' + s).join('\n') : '-'}

ğŸ§ ì¶œì„ì²´í¬
${attendees.length ? attendees.map(s => '- ' + s).join('\n') : '-'}`.trim();

  document.getElementById('markdownOutput').textContent = markdown;

  navigator.clipboard.writeText(markdown).then(() => {
    alert('âœ… ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ë„¤ì´ë²„ ì¹´í˜ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
  }).catch(err => {
    alert('âŒ ë³µì‚¬ ì‹¤íŒ¨: ' + err);
  });
};

function formatDate(yyyymmdd) {
  if (!yyyymmdd || yyyymmdd.length !== 8) return yyyymmdd;
  return `${yyyymmdd.substring(0,4)}.${yyyymmdd.substring(4,6)}.${yyyymmdd.substring(6)}`;
}

</script>

  </body>
</html>
